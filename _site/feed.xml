<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://themagnificent11.github.io/themagnificent11/feed.xml" rel="self" type="application/atom+xml" /><link href="https://themagnificent11.github.io/themagnificent11/" rel="alternate" type="text/html" /><updated>2025-11-01T05:45:25+00:00</updated><id>https://themagnificent11.github.io/themagnificent11/feed.xml</id><title type="html">TheMagnificent11’s Blog</title><subtitle>A .Net engineer&apos;s thoughts on domain-driven design, observability, and software engineering</subtitle><author><name>Saji Weerasingham</name></author><entry><title type="html">Domain event dispatching using the outbox pattern with Entity Framework</title><link href="https://themagnificent11.github.io/themagnificent11/posts/2025-04-06-outbox-domain-event-dispatching-with-ef/" rel="alternate" type="text/html" title="Domain event dispatching using the outbox pattern with Entity Framework" /><published>2025-04-06T00:00:00+00:00</published><updated>2025-04-06T00:00:00+00:00</updated><id>https://themagnificent11.github.io/themagnificent11/posts/outbox-domain-event-dispatching-with-ef</id><content type="html" xml:base="https://themagnificent11.github.io/themagnificent11/posts/2025-04-06-outbox-domain-event-dispatching-with-ef/"><![CDATA[<h1 id="domain-event-dispatching-using-the-outbox-pattern-with-entity-framework">Domain event dispatching using the outbox pattern with Entity Framework</h1>

<h2 id="what-is-domain-event-dispatching">What is domain event dispatching?</h2>

<p>Domain event dispatching is a concept that related to <a href="https://martinfowler.com/bliki/DomainDrivenDesign.html">domain-driven design</a>, or DDD as it’s also known.</p>

<p>Having said that, event dispatching is central to any <a href="https://learn.microsoft.com/en-us/azure/architecture/guide/architecture-styles/event-driven">event-driven architecture</a>, which follows the <a href="https://learn.microsoft.com/en-us/azure/architecture/patterns/publisher-subscriber">publisher-subscriber pattern</a>.</p>

<p>Now, I’ve not actually read Eric Evans’ seminal book on domain-driven design, <a href="https://www.amazon.com.au/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215">Domain-driven Design: Tackling Complexity in the Heart of Software</a>, so I’m unsure whether Evans suggests whether domain events should be published as part of the transaction that creates them, or have the event persisted with the change in application state and then later published using an <a href="https://codeopinion.com/outbox-pattern-reliably-save-state-publish-events">outbox pattern</a>.</p>

<p>I prefer the outbox pattern for domain event dispatching because I don’t think you want a scenario where data is persisted and an event is raised that has multiple subscribers, but one of the subscribers fails to execute, causing the whole transation to be rolled back.</p>

<p>You then get an inconsistent scenario where certain event handlers have been handled, but the data that relates to those actions does not exist.  Why send a confirmation email for an account that wasn’t successfully regsitered.</p>

<p>Or, conversely, the transaction is not rolled back and one subscriber has failed to execute (including retries with back-off).</p>

<p>Theoutbox pattern, keeps a record of whether the event has been dispatched or “sent”, behaving a bit like a service bus.</p>

<p>In this blog post, I’m going to explore how an application using <a href="https://learn.microsoft.com/en-us/aspnet/entity-framework">Entity Framework</a> as an ORM can use an outbox pattern to publish domain events that are persisted with the application data.</p>

<p>The packages used will be Entity Framewok and I will leverage <code class="language-plaintext highlighter-rouge">INotification</code> in <a href="https://github.com/jbogard/MediatR">MediatR</a> to assist with the publisher-subscriber implementation.</p>

<p>All of these code samples are taken from my <a href="https://github.com/TheMagnificent11/lewee">Lewee</a> project.</p>

<h2 id="domain-event">Domain Event</h2>

<p>Here’s rough representation of a domain event.</p>

<p>I’ve included a <code class="language-plaintext highlighter-rouge">CorrelationId</code> property that I believe should be set to allow you to correlate the logs from the original transaction that persisted the <a href="https://martinfowler.com/bliki/DDD_Aggregate.html">aggregate root</a> and all the subsequent events that get handled as part of the dispatching.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">IDomainEvent</span> <span class="p">:</span> <span class="n">INotification</span>
<span class="p">{</span>
    <span class="n">Guid</span> <span class="n">CorrelationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s a sample implementation of an menu item being added to the table’s order at a restaurant.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MenuItemAddedToOrderDomainEvent</span> <span class="p">:</span> <span class="n">IDomainEvent</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">MenuItemAddedToOrderDomainEvent</span><span class="p">(</span>
        <span class="n">Guid</span> <span class="n">correlationId</span><span class="p">,</span>
        <span class="n">Guid</span> <span class="n">tableId</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">tableNumber</span><span class="p">,</span>
        <span class="n">Guid</span> <span class="n">orderId</span><span class="p">,</span>
        <span class="n">Guid</span> <span class="n">menuItemId</span><span class="p">,</span>
        <span class="kt">decimal</span> <span class="n">price</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">CorrelationId</span> <span class="p">=</span> <span class="n">correlationId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">TableId</span> <span class="p">=</span> <span class="n">tableId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">TableNumber</span> <span class="p">=</span> <span class="n">tableNumber</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">OrderId</span> <span class="p">=</span> <span class="n">orderId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">MenuItemId</span> <span class="p">=</span> <span class="n">menuItemId</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Price</span> <span class="p">=</span> <span class="n">price</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Guid</span> <span class="n">CorrelationId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">TableId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">TableNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">OrderId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">Guid</span> <span class="n">MenuItemId</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">decimal</span> <span class="n">Price</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="storing-domain-events">Storing Domain Events</h2>

<h3 id="entity-framework-entity">Entity Framework Entity</h3>

<p>Below is entity class used to store the details about a domain event after it related aggregate root has been persisted.</p>

<p>Things to note, we are storing the domain event as JSON (<code class="language-plaintext highlighter-rouge">DomainEventJson</code>) and also storing the assembly name (<code class="language-plaintext highlighter-rouge">DomainEventAssemblyName</code>) and class name (<code class="language-plaintext highlighter-rouge">DomainEventClassName</code>) to allow us to deserialize the JSON back to the doamin event in the <code class="language-plaintext highlighter-rouge">ToDomainEvent</code> method.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text.Json</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DomainEventReference</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">DomainEventReference</span><span class="p">(</span><span class="n">DomainEvent</span> <span class="n">domainEvent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Id</span> <span class="p">=</span> <span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DomainEventAssemblyName</span> <span class="p">=</span> <span class="n">assemblyName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DomainEventClassName</span> <span class="p">=</span> <span class="n">fullClassName</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DomainEventJson</span> <span class="p">=</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Serialize</span><span class="p">(</span><span class="n">domainEvent</span><span class="p">,</span> <span class="n">domainEventType</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="n">PersistedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Dispatched</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// EF constructor</span>
    <span class="k">private</span> <span class="nf">DomainEventReference</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DomainEventAssemblyName</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DomainEventClassName</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DomainEventJson</span> <span class="p">=</span> <span class="s">"{}"</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">PersistedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Dispatched</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Guid</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">DomainEventAssemblyName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">DomainEventClassName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">DomainEventJson</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">Dispatched</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span> <span class="n">PersistedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">DateTime</span><span class="p">?</span> <span class="n">DispatchedAt</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="n">DomainEvent</span><span class="p">?</span> <span class="nf">ToDomainEvent</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">DomainEventJson</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">assembly</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">DomainEventAssemblyName</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">targetType</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">DomainEventClassName</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">targetType</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">objDomainEvent</span> <span class="p">=</span> <span class="nf">Deserialize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">DomainEventJson</span><span class="p">,</span> <span class="n">targetType</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">objDomainEvent</span> <span class="k">is</span> <span class="n">not</span> <span class="n">DomainEvent</span> <span class="n">domainEvent</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">domainEvent</span><span class="p">.</span><span class="n">UserId</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">UserId</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">domainEvent</span><span class="p">;</span>

        <span class="k">static</span> <span class="kt">object</span><span class="p">?</span> <span class="nf">Deserialize</span><span class="p">(</span><span class="kt">string</span> <span class="n">json</span><span class="p">,</span> <span class="n">Type</span> <span class="n">type</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">JsonSerializer</span><span class="p">.</span><span class="nf">Deserialize</span><span class="p">(</span><span class="n">json</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Dispatch</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">Dispatched</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DispatchedAt</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s how we’ve configured the underlying database table.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore.Metadata.Builders</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DomainEventReferenceConfiguration</span> <span class="p">:</span> <span class="n">IEntityTypeConfiguration</span><span class="p">&lt;</span><span class="n">DomainEventReference</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configure</span><span class="p">(</span><span class="n">EntityTypeBuilder</span><span class="p">&lt;</span><span class="n">DomainEventReference</span><span class="p">&gt;</span> <span class="n">builder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">builder</span><span class="p">.</span><span class="nf">HasKey</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">DomainEventAssemblyName</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">HasMaxLength</span><span class="p">(</span><span class="m">255</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">IsRequired</span><span class="p">();</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">DomainEventClassName</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">HasMaxLength</span><span class="p">(</span><span class="m">255</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">IsRequired</span><span class="p">();</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">DomainEventJson</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">HasMaxLength</span><span class="p">(</span><span class="m">8000</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">IsRequired</span><span class="p">();</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Dispatched</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">IsRequired</span><span class="p">();</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">PersistedAt</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">IsRequired</span><span class="p">();</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">DispatchedAt</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">IsRequired</span><span class="p">(</span><span class="k">false</span><span class="p">);</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">Property</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">UserId</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">HasMaxLength</span><span class="p">(</span><span class="m">50</span><span class="p">);</span>

        <span class="n">builder</span><span class="p">.</span><span class="nf">HasIndex</span><span class="p">(</span>
            <span class="k">nameof</span><span class="p">(</span><span class="n">DomainEventReference</span><span class="p">.</span><span class="n">Dispatched</span><span class="p">),</span>
            <span class="k">nameof</span><span class="p">(</span><span class="n">DomainEventReference</span><span class="p">.</span><span class="n">PersistedAt</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="how-the-aggregate-root-stores-the-domain-event">How the aggregate root stores the domain event</h3>

<p>The aggregate root needs a collection of domain events on it.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DomainEventsCollection</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DomainEvent</span><span class="p">&gt;</span> <span class="n">domainEvents</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">syncLock</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">void</span> <span class="n">Raise</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">domainEvent</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">DomainEvent</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">syncLock</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">domainEvents</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">domainEvent</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">DomainEvent</span><span class="p">[]</span> <span class="nf">GetAndClear</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">lock</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">syncLock</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">events</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">domainEvents</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="n">domainEvents</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>


            <span class="k">return</span> <span class="n">events</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">AggregateRoot</span> <span class="p">:</span> <span class="n">Entity</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nf">AggregateRoot</span><span class="p">()</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">Guid</span><span class="p">.</span><span class="nf">NewGuid</span><span class="p">())</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="nf">AggregateRoot</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">DomainEventsCollection</span> <span class="n">DomainEvents</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DomainEventsCollection</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s a sample implementation of an aggregate root “raising” a domain event.</p>

<p>In this example, a menu item is being added to the order of a table at a restaurant.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Table</span> <span class="p">:</span> <span class="n">AggregateRoot</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">orders</span> <span class="p">=</span> <span class="k">new</span><span class="p">();</span>

    <span class="k">public</span> <span class="nf">Table</span><span class="p">(</span><span class="n">Guid</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tableNumber</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">TableNumber</span> <span class="p">=</span> <span class="n">tableNumber</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">Order</span><span class="p">?</span> <span class="n">CurrentOrder</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">orders</span>
        <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">OrderStatusId</span> <span class="p">!=</span> <span class="n">OrderStatus</span><span class="p">.</span><span class="n">Paid</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">x</span><span class="p">.</span><span class="n">IsDeleted</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">OrderByDescending</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">CreatedAtUtc</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">();</span>

    <span class="k">public</span> <span class="kt">int</span> <span class="n">TableNumber</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsInUse</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">protected</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">IReadOnlyCollection</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span> <span class="n">Orders</span> <span class="p">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">orders</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OrderMenuItem</span><span class="p">(</span><span class="n">MenuItem</span> <span class="n">menuItem</span><span class="p">,</span> <span class="n">Guid</span> <span class="n">correlationId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="k">this</span><span class="p">.</span><span class="n">IsInUse</span> <span class="p">||</span> <span class="k">this</span><span class="p">.</span><span class="n">CurrentOrder</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">DomainException</span><span class="p">(</span><span class="n">ErrorMessages</span><span class="p">.</span><span class="n">CannotOrderIfTableNotInUse</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="n">CurrentOrder</span><span class="p">.</span><span class="nf">AddItem</span><span class="p">(</span><span class="n">menuItem</span><span class="p">);</span>

        <span class="k">this</span><span class="p">.</span><span class="n">DomainEvents</span><span class="p">.</span><span class="nf">Raise</span><span class="p">(</span><span class="k">new</span> <span class="nf">MenuItemAddedToOrderDomainEvent</span><span class="p">(</span>
            <span class="n">correlationId</span><span class="p">,</span>
            <span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="k">this</span><span class="p">.</span><span class="n">TableNumber</span><span class="p">,</span>
            <span class="k">this</span><span class="p">.</span><span class="n">CurrentOrder</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="n">menuItem</span><span class="p">.</span><span class="n">Id</span><span class="p">,</span>
            <span class="n">menuItem</span><span class="p">.</span><span class="n">Price</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ErrorMessages</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">CannotOrderIfTableNotInUse</span> <span class="p">=</span> <span class="s">"Cannot order items if table is not in use"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="how-the-dbcontext-stores-the-domain-event">How the DbContext stores the domain event</h3>

<p>We are going to use a <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.diagnostics.savechangesinterceptor">SaveChangesInterceptor</a> to find the domain events added to our aggregate roots and add them as <code class="language-plaintext highlighter-rouge">DomainEventReference</code> instances before “save changes” executes.</p>

<p>To do that, we need to be able easily identify the <code class="language-plaintext highlighter-rouge">DbSet</code> for our <code class="language-plaintext highlighter-rouge">DomainEventReference</code> entities.</p>

<p>So, we’ve created an <code class="language-plaintext highlighter-rouge">IApplicationDbContext</code> interface that we can add to our Entity Framework <code class="language-plaintext highlighter-rouge">DbContext</code>.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IApplicationDbContext</span>
<span class="p">{</span>
    <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">DomainEventReference</span><span class="p">&gt;?</span> <span class="n">DomainEventReferences</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s the interceptor that find the domain events on the aggregate roots and stores them in the <code class="language-plaintext highlighter-rouge">DbContext</code>.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore.ChangeTracking</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore.Diagnostics</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DomainEventSaveChangesInterceptor</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">SaveChangesInterceptor</span>
    <span class="k">where</span> <span class="n">TContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IApplicationDbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="nf">SavingChanges</span><span class="p">(</span>
        <span class="n">DbContextEventData</span> <span class="n">eventData</span><span class="p">,</span>
        <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">StoreDomainEvents</span><span class="p">(</span><span class="n">eventData</span><span class="p">.</span><span class="n">Context</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">SavingChanges</span><span class="p">(</span><span class="n">eventData</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="n">ValueTask</span><span class="p">&lt;</span><span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="nf">SavingChangesAsync</span><span class="p">(</span>
        <span class="n">DbContextEventData</span> <span class="n">eventData</span><span class="p">,</span>
        <span class="n">InterceptionResult</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">result</span><span class="p">,</span>
        <span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">default</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nf">StoreDomainEvents</span><span class="p">(</span><span class="n">eventData</span><span class="p">.</span><span class="n">Context</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">SavingChangesAsync</span><span class="p">(</span><span class="n">eventData</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">StoreDomainEvents</span><span class="p">(</span><span class="n">DbContext</span><span class="p">?</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">context</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">context</span> <span class="k">is</span> <span class="n">not</span> <span class="n">TContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">entry</span> <span class="k">in</span> <span class="n">context</span><span class="p">.</span><span class="n">ChangeTracker</span><span class="p">.</span><span class="nf">Entries</span><span class="p">().</span><span class="nf">ToList</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nf">StoreDomainEventsForEntry</span><span class="p">((</span><span class="n">TContext</span><span class="p">)</span><span class="n">context</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">StoreDomainEventsForEntry</span><span class="p">(</span><span class="n">TContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">EntityEntry</span> <span class="n">entry</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">Entity</span> <span class="k">is</span> <span class="n">not</span> <span class="n">AggregateRoot</span> <span class="n">aggregateRootEntity</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">var</span> <span class="n">events</span> <span class="p">=</span> <span class="n">aggregateRootEntity</span><span class="p">.</span><span class="n">DomainEvents</span><span class="p">.</span><span class="nf">GetAndClear</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">domainEvent</span> <span class="k">in</span> <span class="n">events</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">domainEvent</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">reference</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DomainEventReference</span><span class="p">(</span><span class="n">domainEvent</span><span class="p">);</span>

            <span class="n">context</span><span class="p">.</span><span class="n">DomainEventReferences</span><span class="p">?.</span><span class="nf">Add</span><span class="p">(</span><span class="n">reference</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, here’s an abstract <code class="language-plaintext highlighter-rouge">DbContext</code> implementation that exposes the <code class="language-plaintext highlighter-rouge">DomainEventReference</code> <code class="language-plaintext highlighter-rouge">DbSet</code> and adds the <code class="language-plaintext highlighter-rouge">DomainEventSaveChangesInterceptor</code>.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>

<span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ApplicationDbContext</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IApplicationDbContext</span>
    <span class="k">where</span> <span class="n">TContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IApplicationDbContext</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nf">ApplicationDbContext</span><span class="p">(</span><span class="n">DbContextOptions</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">DbSet</span><span class="p">&lt;</span><span class="n">DomainEventReference</span><span class="p">&gt;?</span> <span class="n">DomainEventReferences</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">internal</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnModelCreating</span><span class="p">(</span><span class="n">modelBuilder</span><span class="p">);</span>

        <span class="n">modelBuilder</span><span class="p">.</span><span class="nf">ApplyConfiguration</span><span class="p">(</span><span class="k">new</span> <span class="nf">DomainEventReferenceConfiguration</span><span class="p">());</span>

        <span class="k">this</span><span class="p">.</span><span class="nf">ConfigureDatabaseModel</span><span class="p">(</span><span class="n">modelBuilder</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnConfiguring</span><span class="p">(</span><span class="n">DbContextOptionsBuilder</span> <span class="n">optionsBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">base</span><span class="p">.</span><span class="nf">OnConfiguring</span><span class="p">(</span><span class="n">optionsBuilder</span><span class="p">);</span>

        <span class="n">optionsBuilder</span><span class="p">.</span><span class="nf">AddInterceptors</span><span class="p">(</span><span class="k">new</span> <span class="n">DomainEventSaveChangesInterceptor</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;());</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">void</span> <span class="nf">ConfigureDatabaseModel</span><span class="p">(</span><span class="n">ModelBuilder</span> <span class="n">modelBuilder</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="dispatching-domain-events">Dispatching Domain Events</h2>

<p>The code below reads from the database table for the <code class="language-plaintext highlighter-rouge">DomainEventReference</code> entity and dispatches them in batches of 50.</p>

<p>For event row, it deserializes the JSON to the original <code class="language-plaintext highlighter-rouge">IDomainEvent</code> and because <code class="language-plaintext highlighter-rouge">IDomainEvent</code> implements <code class="language-plaintext highlighter-rouge">INotification</code> from <code class="language-plaintext highlighter-rouge">MediatR</code>, you can use the <code class="language-plaintext highlighter-rouge">Publish</code> to achieve the publisher-subscriber pattern; there can be multiple notification handlers for each event.  Conversely, if there are not notification handlers, <code class="language-plaintext highlighter-rouge">MediatR</code> will handle this for us and return successfully.</p>

<p>The domain event does not get marked as “dispatched” in the database unless all dispatching succeeds.</p>

<p>There is a downside here because you could have three notification handlers for an event, two could succeed and one could fail, causing the event does not get marked as dispatched.</p>

<p>Any process that tries to re-dispatch will attempt all three handlers again, so you could get duplication of certain handlers.</p>

<p>However, I think this is still better than the other scenario I outlined earlier.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Serilog</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DomainEventDispatcher</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span>
    <span class="k">where</span> <span class="n">TContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IApplicationDbContext</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">BatchSize</span> <span class="p">=</span> <span class="m">50</span><span class="p">;</span>

    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IDbContextFactory</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">dbContextFactory</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">DomainEventDispatcher</span><span class="p">(</span>
        <span class="n">IDbContextFactory</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">dbContextFactory</span><span class="p">,</span>
        <span class="n">IMediator</span> <span class="n">mediator</span><span class="p">,</span>
        <span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">dbContextFactory</span> <span class="p">=</span> <span class="n">dbContextFactory</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">mediator</span> <span class="p">=</span> <span class="n">mediator</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">.</span><span class="n">ForContext</span><span class="p">&lt;</span><span class="n">DomainEventDispatcher</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;&gt;();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DispatchEvents</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">eventsToDispatch</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">ThereAreEventsToDispatch</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">eventsToDispatch</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">cancellationToken</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">DispatchBatch</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>

            <span class="n">eventsToDispatch</span> <span class="p">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nf">ThereAreEventsToDispatch</span><span class="p">(</span><span class="n">cancellationToken</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="nf">ThereAreEventsToDispatch</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">dbContextFactory</span><span class="p">.</span><span class="nf">CreateDbContext</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">dbSet</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">DomainEventReference</span><span class="p">&gt;();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">dbSet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">await</span> <span class="n">dbSet</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">x</span><span class="p">.</span><span class="n">Dispatched</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">PersistedAt</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">AnyAsync</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">DispatchBatch</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">token</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">scope</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">dbContextFactory</span><span class="p">.</span><span class="nf">CreateDbContext</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">dbSet</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">Set</span><span class="p">&lt;</span><span class="n">DomainEventReference</span><span class="p">&gt;();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dbSet</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="kt">var</span> <span class="n">events</span> <span class="p">=</span> <span class="k">await</span> <span class="n">dbSet</span>
                <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="p">!</span><span class="n">x</span><span class="p">.</span><span class="n">Dispatched</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">OrderBy</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">PersistedAt</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Take</span><span class="p">(</span><span class="n">BatchSize</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">ToArrayAsync</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">domainEvents</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DomainEvent</span><span class="p">&gt;();</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">domainEventReference</span> <span class="k">in</span> <span class="n">events</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">domainEventReference</span><span class="p">.</span><span class="nf">Dispatch</span><span class="p">();</span>

                <span class="kt">var</span> <span class="n">domainEvent</span> <span class="p">=</span> <span class="n">domainEventReference</span><span class="p">.</span><span class="nf">ToDomainEvent</span><span class="p">();</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">domainEvent</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="nf">Warning</span><span class="p">(</span>
                        <span class="s">"Could not deserialize DomainEventReference {Id}"</span><span class="p">,</span>
                        <span class="n">domainEventReference</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">domainEvents</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">domainEvent</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">domainEvents</span><span class="p">.</span><span class="nf">Any</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">domainEvent</span> <span class="k">in</span> <span class="n">domainEvents</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">mediator</span><span class="p">.</span><span class="nf">Publish</span><span class="p">(</span><span class="n">domainEvent</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">await</span> <span class="n">scope</span><span class="p">.</span><span class="nf">SaveChangesAsync</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So the code above does the dispatching, but what triggers the dispatching?</p>

<p>As far as I know, there is nothing similar to the <code class="language-plaintext highlighter-rouge">SaveChangesInterceptor</code> that executes after a successful save changes.</p>

<p>So, we’ve decided to use a background service.</p>

<p>In the code below, we are expecting our <code class="language-plaintext highlighter-rouge">DomainEventDispatcher</code> to dispatch events every 2.5 seconds.</p>

<p>So, any events that failed to dispatch will be retried after 2.5 seconds.</p>

<p><code class="language-plaintext highlighter-rouge">DomainEventReference</code> does not currently have a “retry count” or a “failed” property and that is definitely an improvement that could be added; fail if retried 10 times.</p>

<p>Under this solution, we will keep retrying and failed events will be attempted before new events, potentially causing a performance issue if failed events build up.</p>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Hosting</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">Lewee.Infrastructure.Data</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">DomainEventDispatcherService</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">BackgroundService</span>
    <span class="k">where</span> <span class="n">TContext</span> <span class="p">:</span> <span class="n">DbContext</span><span class="p">,</span> <span class="n">IApplicationDbContext</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">DomainEventDispatcherService</span><span class="p">(</span><span class="n">DomainEventDispatcher</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">domainEventDispatcher</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">DomainEventDispatcher</span> <span class="p">=</span> <span class="n">domainEventDispatcher</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">DomainEventDispatcher</span><span class="p">&lt;</span><span class="n">TContext</span><span class="p">&gt;</span> <span class="n">DomainEventDispatcher</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">protected</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">ExecuteAsync</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">stoppingToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span> <span class="p">(!</span><span class="n">stoppingToken</span><span class="p">.</span><span class="n">IsCancellationRequested</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="n">DomainEventDispatcher</span><span class="p">.</span><span class="nf">DispatchEvents</span><span class="p">(</span><span class="n">stoppingToken</span><span class="p">);</span>


            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="nf">Delay</span><span class="p">(</span><span class="m">2500</span><span class="p">,</span> <span class="n">stoppingToken</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There are definitely better ways to achieve this.</p>

<p>You could override save changes on your <code class="language-plaintext highlighter-rouge">DbContext</code> to trigger your domain event dispatcher and later you use some sort of retry policy if any events fails to dispatch.</p>

<p>That would be more efficient, but more complicated and harder to implement.</p>

<h2 id="dependency-injection-configuration">Dependency Injection Configuration</h2>

<div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Microsoft.EntityFrameworkCore</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.DependencyInjection</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">ApplicationDbContextServiceCollectionExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="n">ConfigureDatabase</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
        <span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">,</span>
        <span class="kt">string</span> <span class="n">connectionString</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">ApplicationDbContext</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="n">services</span><span class="p">.</span><span class="n">AddDbContextFactory</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span> <span class="n">options</span><span class="p">.</span><span class="nf">UseSqlServer</span><span class="p">(</span><span class="n">connectionString</span><span class="p">));</span>
        <span class="n">services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>

        <span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">DomainEventDispatcher</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;();</span>
        <span class="n">services</span><span class="p">.</span><span class="n">AddHostedService</span><span class="p">&lt;</span><span class="n">DomainEventDispatcherService</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;();</span>

        <span class="k">return</span> <span class="n">services</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="this-is-a-lot-of-boilerplate">This is a lot of boilerplate</h2>

<p>This seems like a lot of code to achieve what I’d expect to be relatively straight-forward.</p>

<p>Given this is fairly common pattern and that DDD is used by a lot in software development, you’d expect that there are frameworks that do this for you.</p>

<p>That’s what I’ve tried to achieve with <a href="https://github.com/TheMagnificent11/lewee">Lewee</a>.</p>

<p>However, there’s definitely a better way.</p>

<p>In a future blog post, I’d like to explore how to dispatch to a message broker, probably <code class="language-plaintext highlighter-rouge">RabbitMQ</code> via <a href="https://masstransit.io">MassTransit</a>, instead of using <code class="language-plaintext highlighter-rouge">Mediatr</code> notifications.  I feel like this is more flexible as any service within your distributed application can handle your domain events. not just the service that dispatches it.</p>]]></content><author><name>Saji Weerasingham</name></author><category term="domain-driven-design" /><category term="entity-framework" /><category term="outbox-pattern" /><summary type="html"><![CDATA[Domain event dispatching using the outbox pattern with Entity Framework]]></summary></entry></feed>